# This file is generated by the template.

REGISTRY?=cr.loongnix.cn
ORGANIZATION?=library
REPOSITORY?=kong
TAG?=2.7.0-centos
LATEST?=true

IMAGE=$(REGISTRY)/$(ORGANIZATION)/$(REPOSITORY):$(TAG)
LATEST_IMAGE=$(REGISTRY)/$(ORGANIZATION)/$(REPOSITORY):latest

# SOURCE_URL is a url to download source, such as https://github.com/merore/merore.git.
# SOURCE is project sources, its located at src/$(SORUCE).
# PATCH is a patch that supports loong64 to $(SOURCE).
# Be sure to fill in the follows!!!
DOCKER_KONG_SOURCE_URL=https://github.com/Kong/docker-kong.git
KONG_SOURCE_URL=https://github.com/Kong/kong.git
KONG_BUILD_TOOLS_SOURCE_URL=https://github.com/Kong/kong-build-tools.git
SOURCE=$(shell echo $(DOCKER_KONG_SOURCE_URL) | awk -F '/' '{print $$NF}' | awk -F '.' '{print $$1}')
PATCH_FOR_DOCKER_KONG=0001-port-to-loong64.patch
PATCH_FOR_KONG_BUILD_TOOLS=0002-port-to-loong64.patch
KONG_VERSION=2.6.0
KONG_BUILD_TOOLS_VERSION=4.42.0
IS_ROOT := $(shell id -u)
ifneq ($(IS_ROOT), 0)
	SUDO=sudo
endif

default: image

image: kong-rpm
# Commands for building.
	$(SUDO) $(MAKE) -C src/$(SOURCE) build

kong-rpm: src/$(SOURCE)
	$(SUDO) $(MAKE) -C src/kong-build-tools package-kong
	@ls src/kong-build-tools/output
	rm $</centos/kong.rpm
	cp src/kong-build-tools/output/*.rpm $</centos/kong.rpm

src/$(SOURCE): src/kong src/kong-build-tools
	echo "src/$(SOURCE)"
	cp -r /home/yzw/yzw/docker-kong src/docker-kong
	#git clone -b $(KONG_VERSION) --depth=1 $(DOCKER_KONG_SOURCE_URL) $@
	#cd $@ && \
#		git apply ../../$(PATCH_FOR_DOCKER_KONG)

src/kong:
	git clone -b $(KONG_VERSION) --depth=1 $(KONG_SOURCE_URL) $@
	cd $@ && \
                git apply ../../0003.patch

src/kong-build-tools:
	git clone -b $(KONG_BUILD_TOOLS_VERSION) --depth=1 $(KONG_BUILD_TOOLS_SOURCE_URL) $@
	cd $@ && \
		git apply ../../$(PATCH_FOR_KONG_BUILD_TOOLS)

push:
	docker push $(IMAGE)
	@if [ $(LATEST) = "true" ]; \
		then\
		docker tag $(IMAGE) $(LATEST_IMAGE); \
		docker push $(LATEST_IMAGE); \
	fi

clean:
	$(SUDO) rm -rf src
