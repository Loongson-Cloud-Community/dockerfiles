# This file is generated by the template.

REGISTRY?=cr.loongnix.cn
ORGANIZATION?=calico

TAG?=v3.26.1
LATEST?=false


IMG_TAG ?= $(patsubst v%,%,$(TAG))
CALICO_BUILD ?= cr.loongnix.cn/calico/go-build:0.85
GOPROXY ?= https://goproxy.cn,https://mirrors.aliyun.com/goproxy/,https://goproxy.io,direct

SOURCE_URL=https://github.com/projectcalico/calico.git
SOURCE=$(shell echo $(SOURCE_URL) | awk -F '/' '{print $$NF}' | awk -F '.' '{print $$1}')
PATCH=0001-support-loong64.patch


BUILD_TG ?= \
    pod2daemon \
    calicoctl \
    cni-plugin \
    apiserver \
    kube-controllers \
    app-policy \
    typha \
    node

PUSH_IMG ?= $(BUILD_TG) flannel-migration-controller

THIS_DIR := $(dir $(realpath $(lastword $(MAKEFILE_LIST))))

default: image

src/$(SOURCE):
	git clone -q -b $(TAG) --depth=1 $(SOURCE_URL) $@
	cd $@ && \
		git apply ../../$(PATCH)

image: src/$(SOURCE)
	@$(foreach value, $(BUILD_TG), \
		EXTRA_DOCKER_ARGS="-e HTTPS_PROXY=$(http_proxy) -e HTTP_PROXY=$(http_proxy)" \
		GOPROXY="" \
		BUILDARCH=loong64 \
			BIRD_IMAGE=cr.loongnix.cn/calico/bird:0.3.3 \
			UBI_IMAGE=cr.loongnix.cn/library/centos:8.3 \
			CALICO_BUILD=$(CALICO_BUILD) \
			IMAGE_NAME=$(REGISTRY)/$(ORGANIZATION)/$(value):$(IMG_TAG) \
			FLANNEL_IMAGE_NAME=$(REGISTRY)/$(ORGANIZATION)/flannel-migration-controller:$(IMG_TAG) \
			GOMOD_CACHE=$(THIS_DIR)src/go-mod make -C src/$(SOURCE)/$(value) image IMAGETAG=$(TAG) VALIDARCHES=loong64; \
	)

push:
	@$(foreach value, $(PUSH_IMG), \
		echo docker push $(REGISTRY)/$(ORGANIZATION)/$(value):$(IMG_TAG); \
		if [ $(LATEST) = "true" ]; then \
			$(eval LATEST_IMAGE=$(REGISTRY)/$(ORGANIZATION)/$(value):latest) \
			docker tag $(REGISTRY)/$(ORGANIZATION)/$(value):$(IMG_TAG) ${LATEST_IMAGE}; \
			docker push $(LATEST_IMAGE); \
		fi; \
	)


clean:
	rm -rf src
