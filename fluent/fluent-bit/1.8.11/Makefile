# This file is generated by the template.

REGISTRY?=cr.loongnix.cn
ORGANIZATION?=fluent
REPOSITORY?=fluent-bit
TAG?=1.8.11

IMAGE=$(REGISTRY)/$(ORGANIZATION)/$(REPOSITORY):$(TAG)

FLUENT_BIT_REGISTRY?=https://github.com/fluent/fluent-bit.git

LUAJIT_REGISTRY?=https://github.com/loongson/luajit2.git

LUAJIT_TAG?=v2.1-agentzh-loongarch64

FLB_TARBALL=https://github.com/fluent/fluent-bit/archive/v$(TAG).tar.gz

default: image

conf:
	git clone --branch v$(TAG) $(FLUENT_BIT_REGISTRY)
	mv fluent-bit/dockerfiles/conf .
	rm -rf fluent-bit

luajit-2.1:
	git clone --branch $(LUAJIT_TAG) $(LUAJIT_REGISTRY)
	mv luajit2 luajit-2.1

fluent-bit-v$(TAG).tar.gz:
	wget -O fluent-bit-v$(TAG).tar.gz "$(FLB_TARBALL)"

download: conf luajit-2.1 fluent-bit-v$(TAG).tar.gz

image: download
	docker build \
		-t $(IMAGE) \
		.

push:
	docker push $(IMAGE)
